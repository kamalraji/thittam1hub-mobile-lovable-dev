// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ORGANIZER
  PARTICIPANT
  JUDGE
  VOLUNTEER
  SPEAKER
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum EventMode {
  OFFLINE
  ONLINE
  HYBRID
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ONGOING
  COMPLETED
  CANCELLED
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  WAITLISTED
  CANCELLED
}

enum CertificateType {
  MERIT
  COMPLETION
  APPRECIATION
}

enum OrganizationCategory {
  COLLEGE
  COMPANY
  INDUSTRY
  NON_PROFIT
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum EventVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

enum WorkspaceStatus {
  PROVISIONING
  ACTIVE
  WINDING_DOWN
  DISSOLVED
}

enum WorkspaceRole {
  WORKSPACE_OWNER
  TEAM_LEAD
  EVENT_COORDINATOR
  VOLUNTEER_MANAGER
  TECHNICAL_SPECIALIST
  MARKETING_LEAD
  GENERAL_VOLUNTEER
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  REVIEW_REQUIRED
  COMPLETED
  BLOCKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskCategory {
  SETUP
  MARKETING
  LOGISTICS
  TECHNICAL
  REGISTRATION
  POST_EVENT
}

enum ChannelType {
  GENERAL
  TASK_SPECIFIC
  ROLE_BASED
  ANNOUNCEMENT
}

enum MemberStatus {
  INVITED
  ACTIVE
  INACTIVE
}

enum ServiceCategory {
  VENUE
  CATERING
  PHOTOGRAPHY
  VIDEOGRAPHY
  ENTERTAINMENT
  DECORATION
  AUDIO_VISUAL
  TRANSPORTATION
  SECURITY
  CLEANING
  EQUIPMENT_RENTAL
  PRINTING
  MARKETING
  OTHER
}

enum BookingStatus {
  PENDING
  VENDOR_REVIEWING
  QUOTE_SENT
  QUOTE_ACCEPTED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PricingType {
  FIXED
  HOURLY
  PER_PERSON
  CUSTOM_QUOTE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethodType {
  CREDIT_CARD
  BANK_TRANSFER
  DIGITAL_WALLET
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  name          String
  role          UserRole
  status        UserStatus @default(PENDING)
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  qrCode        String   @unique @default(uuid())

  // Relations
  organizedEvents    Event[]              @relation("OrganizerEvents")
  registrations      Registration[]
  scores             Score[]
  certificates       Certificate[]
  communications     CommunicationLog[]
  organizationAdmins OrganizationAdmin[]
  follows            Follow[]
  vendorProfile      VendorProfile?
  bookingRequests    BookingRequest[]     @relation("OrganizerBookings")
  vendorReviews      VendorReview[]
  paymentsSent       PaymentRecord[]      @relation("PaymentPayer")
  paymentsReceived   PaymentRecord[]      @relation("PaymentPayee")
  teamMemberships    TeamMember[]
  invitedTeamMembers TeamMember[]         @relation("TeamMemberInviter")
  workspaceMessages  WorkspaceMessage[]   @relation("WorkspaceMessageSender")

  @@index([email])
}

model Event {
  id                   String          @id @default(uuid())
  name                 String
  description          String          @db.Text
  mode                 EventMode
  startDate            DateTime
  endDate              DateTime
  capacity             Int?
  registrationDeadline DateTime?
  organizerId          String
  organizationId       String?
  visibility           EventVisibility @default(PUBLIC)
  branding             Json
  venue                Json?
  virtualLinks         Json?
  status               EventStatus     @default(DRAFT)
  landingPageUrl       String          @unique
  inviteLink           String?         @unique
  leaderboardEnabled   Boolean         @default(false)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relations
  organizer      User               @relation("OrganizerEvents", fields: [organizerId], references: [id])
  organization   Organization?      @relation(fields: [organizationId], references: [id])
  registrations  Registration[]
  rubric         Rubric?
  certificates   Certificate[]
  communications CommunicationLog[]
  bookingRequests BookingRequest[]
  timelineItems  EventTimelineItem[]
  workspace      Workspace?

  @@index([organizerId])
  @@index([organizationId])
  @@index([landingPageUrl])
  @@index([visibility])
}

model Workspace {
  id          String          @id @default(uuid())
  eventId     String          @unique
  name        String
  description String?         @db.Text
  status      WorkspaceStatus @default(PROVISIONING)
  settings    Json?           // WorkspaceSettings object
  templateId  String?         // Reference to workspace template used
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  dissolvedAt DateTime?

  // Relations
  event        Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  teamMembers  TeamMember[]
  tasks        WorkspaceTask[]
  channels     WorkspaceChannel[]

  @@index([eventId])
  @@index([status])
  @@index([templateId])
}

model TeamMember {
  id          String        @id @default(uuid())
  workspaceId String
  userId      String
  role        WorkspaceRole
  permissions Json?         // Array of permission strings
  joinedAt    DateTime      @default(now())
  leftAt      DateTime?
  invitedBy   String
  status      MemberStatus  @default(ACTIVE)

  // Relations
  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id])
  inviter       User            @relation("TeamMemberInviter", fields: [invitedBy], references: [id])
  assignedTasks WorkspaceTask[] @relation("TaskAssignee")
  createdTasks  WorkspaceTask[] @relation("TaskCreator")

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@index([role])
}

model WorkspaceTask {
  id           String       @id @default(uuid())
  workspaceId  String
  title        String
  description  String       @db.Text
  assigneeId   String?
  creatorId    String
  category     TaskCategory
  priority     TaskPriority @default(MEDIUM)
  status       TaskStatus   @default(NOT_STARTED)
  progress     Int          @default(0) // 0-100
  dueDate      DateTime?
  dependencies Json?        // Array of task IDs
  tags         String[]     @default([])
  metadata     Json?        // Additional task data
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  completedAt  DateTime?

  // Relations
  workspace Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignee  TeamMember? @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator   TeamMember  @relation("TaskCreator", fields: [creatorId], references: [id])

  @@index([workspaceId])
  @@index([assigneeId])
  @@index([creatorId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
}

model WorkspaceChannel {
  id          String      @id @default(uuid())
  workspaceId String
  name        String
  type        ChannelType
  description String?     @db.Text
  members     String[]    @default([]) // Array of user IDs
  isPrivate   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages  WorkspaceMessage[]

  @@index([workspaceId])
  @@index([type])
}

model WorkspaceMessage {
  id          String      @id @default(uuid())
  channelId   String
  senderId    String
  content     String      @db.Text
  attachments Json?       // Array of MediaFile objects
  isPriority  Boolean     @default(false)
  sentAt      DateTime    @default(now())
  editedAt    DateTime?
  deletedAt   DateTime?

  // Relations
  channel WorkspaceChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sender  User             @relation("WorkspaceMessageSender", fields: [senderId], references: [id])

  @@index([channelId])
  @@index([senderId])
  @@index([sentAt])
  @@index([isPriority])
}

model Registration {
  id         String             @id @default(uuid())
  eventId    String
  userId     String
  status     RegistrationStatus @default(PENDING)
  metadata   Json?              // Additional registration data
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  // Relations
  event      Event        @relation(fields: [eventId], references: [id])
  user       User         @relation(fields: [userId], references: [id])
  attendance Attendance[]

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}

model Attendance {
  id             String   @id @default(uuid())
  registrationId String
  sessionId      String?
  checkInTime    DateTime @default(now())
  checkInMethod  String   // 'QR_SCAN' or 'MANUAL'
  volunteerId    String?

  // Relations
  registration Registration @relation(fields: [registrationId], references: [id])

  @@index([registrationId])
}

model Rubric {
  id        String   @id @default(uuid())
  eventId   String   @unique
  criteria  Json
  createdAt DateTime @default(now())

  // Relations
  event       Event        @relation(fields: [eventId], references: [id])
  scores      Score[]
  submissions Submission[]
}

model Submission {
  id          String   @id @default(uuid())
  eventId     String
  rubricId    String
  teamName    String
  description String?  @db.Text
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rubric Rubric  @relation(fields: [rubricId], references: [id])
  scores Score[]

  @@index([eventId])
  @@index([rubricId])
}

model Score {
  id           String   @id @default(uuid())
  submissionId String
  judgeId      String
  rubricId     String
  scores       Json
  submittedAt  DateTime @default(now())

  // Relations
  judge      User       @relation(fields: [judgeId], references: [id])
  rubric     Rubric     @relation(fields: [rubricId], references: [id])
  submission Submission @relation(fields: [submissionId], references: [id])

  @@index([submissionId])
  @@index([judgeId])
  @@index([rubricId])
}

model Certificate {
  id            String          @id @default(uuid())
  certificateId String          @unique
  recipientId   String
  eventId       String
  type          CertificateType
  pdfUrl        String
  qrCodeUrl     String
  metadata      Json
  issuedAt      DateTime        @default(now())
  distributedAt DateTime?

  // Relations
  recipient User  @relation(fields: [recipientId], references: [id])
  event     Event @relation(fields: [eventId], references: [id])

  @@index([certificateId])
  @@index([recipientId])
  @@index([eventId])
}

model CommunicationLog {
  id             String   @id @default(uuid())
  eventId        String
  senderId       String
  recipientCount Int
  subject        String
  sentAt         DateTime @default(now())
  status         String   // 'SENT', 'FAILED', 'PARTIAL'
  metadata       Json?    // Additional communication data

  // Relations
  event  Event @relation(fields: [eventId], references: [id])
  sender User  @relation(fields: [senderId], references: [id])

  @@index([eventId])
  @@index([senderId])
}

model Organization {
  id                 String             @id @default(uuid())
  name               String
  description        String             @db.Text
  category           OrganizationCategory
  verificationStatus VerificationStatus @default(PENDING)
  branding           Json
  socialLinks        Json?
  pageUrl            String             @unique
  followerCount      Int                @default(0)
  rejectionReason    String?            @db.Text
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relations
  events  Event[]
  admins  OrganizationAdmin[]
  follows Follow[]

  @@index([pageUrl])
  @@index([category])
  @@index([verificationStatus])
}

model OrganizationAdmin {
  id             String   @id @default(uuid())
  organizationId String
  userId         String
  role           String   @default("ADMIN") // 'OWNER' or 'ADMIN'
  addedAt        DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model Follow {
  id             String   @id @default(uuid())
  userId         String
  organizationId String
  followedAt     DateTime @default(now())

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

model VendorProfile {
  id                    String             @id @default(uuid())
  userId                String             @unique
  businessName          String
  description           String             @db.Text
  contactInfo           Json               // email, phone, website, socialMedia
  serviceCategories     ServiceCategory[]
  businessAddress       Json               // street, city, state, country, postalCode, coordinates
  verificationStatus    VerificationStatus @default(PENDING)
  verificationDocuments Json?              // businessLicense, insuranceCertificate, etc.
  rating                Float              @default(0)
  reviewCount           Int                @default(0)
  portfolio             Json               // array of MediaFile objects
  businessHours         Json?              // weekly schedule
  responseTime          Int                @default(24) // in hours
  completionRate        Float              @default(100) // percentage
  rejectionReason       String?            @db.Text
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceListings ServiceListing[]
  bookingRequests BookingRequest[] @relation("VendorBookings")
  reviews         VendorReview[]   @relation("VendorReviews")
  timelineItems   EventTimelineItem[]

  @@index([userId])
  @@index([verificationStatus])
  @@index([serviceCategories])
}

model ServiceListing {
  id              String          @id @default(uuid())
  vendorId        String
  title           String
  description     String          @db.Text
  category        ServiceCategory
  pricing         Json            // PricingModel object
  availability    Json            // AvailabilityCalendar object
  serviceArea     String[]        // array of location strings
  requirements    String?         @db.Text
  inclusions      String[]        // array of included services
  exclusions      String[]        // array of excluded services
  media           Json            // array of MediaFile objects
  featured        Boolean         @default(false)
  status          String          @default("ACTIVE") // 'ACTIVE', 'INACTIVE', 'SUSPENDED'
  viewCount       Int             @default(0)
  inquiryCount    Int             @default(0)
  bookingCount    Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  vendor          VendorProfile    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  bookingRequests BookingRequest[]

  @@index([vendorId])
  @@index([category])
  @@index([status])
  @@index([featured])
}

model BookingRequest {
  id              String        @id @default(uuid())
  eventId         String
  serviceListingId String
  organizerId     String
  vendorId        String
  status          BookingStatus @default(PENDING)
  serviceDate     DateTime
  requirements    String        @db.Text
  budgetRange     Json?         // {min: number, max: number}
  quotedPrice     Float?
  finalPrice      Float?
  additionalNotes String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  event           Event            @relation(fields: [eventId], references: [id])
  serviceListing  ServiceListing   @relation(fields: [serviceListingId], references: [id])
  organizer       User             @relation("OrganizerBookings", fields: [organizerId], references: [id])
  vendor          VendorProfile    @relation("VendorBookings", fields: [vendorId], references: [id])
  messages        BookingMessage[]
  paymentRecords  PaymentRecord[]
  review          VendorReview?
  serviceAgreement ServiceAgreement?
  timelineItems   EventTimelineItem[]

  @@index([eventId])
  @@index([serviceListingId])
  @@index([organizerId])
  @@index([vendorId])
  @@index([status])
}

model BookingMessage {
  id         String   @id @default(uuid())
  bookingId  String
  senderId   String
  senderType String   // 'ORGANIZER' or 'VENDOR'
  message    String   @db.Text
  attachments Json?   // array of MediaFile objects
  sentAt     DateTime @default(now())

  // Relations
  booking BookingRequest @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([sentAt])
}

model VendorReview {
  id                String   @id @default(uuid())
  vendorId          String
  bookingId         String   @unique
  organizerId       String
  rating            Int      // 1-5
  title             String
  comment           String   @db.Text
  serviceQuality    Int      // 1-5
  communication     Int      // 1-5
  timeliness        Int      // 1-5
  value             Int      // 1-5
  wouldRecommend    Boolean
  vendorResponse    String?  @db.Text
  vendorResponseAt  DateTime?
  verifiedPurchase  Boolean  @default(true)
  helpful           Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  vendor    VendorProfile  @relation("VendorReviews", fields: [vendorId], references: [id])
  booking   BookingRequest @relation(fields: [bookingId], references: [id])
  organizer User           @relation(fields: [organizerId], references: [id])

  @@index([vendorId])
  @@index([bookingId])
  @@index([organizerId])
  @@index([rating])
  @@index([createdAt])
}

model PaymentRecord {
  id            String            @id @default(uuid())
  bookingId     String
  payerId       String
  payeeId       String
  amount        Float
  currency      String            @default("USD")
  status        PaymentStatus     @default(PENDING)
  paymentMethod Json              // PaymentMethod object
  transactionId String?
  platformFee   Float
  vendorPayout  Float
  processedAt   DateTime?
  createdAt     DateTime          @default(now())

  // Relations
  booking BookingRequest @relation(fields: [bookingId], references: [id])
  payer   User           @relation("PaymentPayer", fields: [payerId], references: [id])
  payee   User           @relation("PaymentPayee", fields: [payeeId], references: [id])

  @@index([bookingId])
  @@index([payerId])
  @@index([payeeId])
  @@index([status])
  @@index([processedAt])
}

model ServiceAgreement {
  id                  String   @id @default(uuid())
  bookingId           String   @unique
  terms               String   @db.Text
  deliverables        Json     // array of Deliverable objects
  paymentSchedule     Json     // array of PaymentMilestone objects
  cancellationPolicy  String   @db.Text
  signedAt            DateTime?
  organizerSignature  String?
  vendorSignature     String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  booking BookingRequest @relation(fields: [bookingId], references: [id])

  @@index([bookingId])
  @@index([signedAt])
}

model EventTimelineItem {
  id             String   @id @default(uuid())
  eventId        String
  bookingId      String?
  deliverableId  String?
  serviceDate    DateTime?
  title          String
  description    String   @db.Text
  dueDate        DateTime
  status         String   // 'PENDING', 'IN_PROGRESS', 'COMPLETED', 'OVERDUE', 'SCHEDULED'
  vendorId       String?
  category       String   // 'VENDOR_DELIVERABLE', 'VENDOR_SERVICE', 'EVENT_MILESTONE'
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  event   Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  booking BookingRequest? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  vendor  VendorProfile? @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  @@unique([eventId, bookingId, deliverableId])
  @@unique([eventId, bookingId, serviceDate])
  @@index([eventId])
  @@index([bookingId])
  @@index([vendorId])
  @@index([dueDate])
  @@index([status])
}
